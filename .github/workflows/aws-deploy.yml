name: Build, Push to ECR and Deploy to EC2

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    name: Build & Push Images to ECR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Java para compilar los jars
      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Maven package
        run: ./mvnw -q -T 1C -DskipTests clean package

      # Login a ECR
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/CoboxGithubOidcRole
          role-session-name: gha-ecr-push

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push images
        run: |
          ECR=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
          TAG=$(date +%Y%m%d-%H%M%S)
          
          declare -a svc=("config-service" "eureka-service" "iam-service" "fleet-service" "delivery-service" "gateway-service")

          for s in "${svc[@]}"; do
            docker build -t $s:latest ./$s
            docker tag $s:latest $ECR/$s:$TAG
            docker tag $s:latest $ECR/$s:latest
            docker push $ECR/$s:$TAG
            docker push $ECR/$s:latest
          done

      - name: Save tag for deploy
        run: echo "IMAGE_TAG=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

  deploy:
    name: Deploy on EC2 via SSH
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    steps:
      - name: Checkout (to get compose)
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Render compose file with ECR images
        run: |
          ECR=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
          cat > docker-compose.aws.yml <<'EOF'
          name: microservices
          services:
            config-service:
              image: ECR/config-service:latest
              container_name: config-service
              environment:
                - SPRING_PROFILES_ACTIVE=native
              ports: ["8888:8888"]
              healthcheck:
                test: ["CMD","curl","-f","http://localhost:8888/actuator/health"]
                interval: 10s
                timeout: 3s
                retries: 20
              restart: unless-stopped
          
            eureka-service:
              image: ECR/eureka-service:latest
              container_name: eureka-service
              depends_on:
                config-service:
                  condition: service_healthy
              ports: ["8761:8761"]
              healthcheck:
                test: ["CMD","curl","-f","http://localhost:8761/actuator/health"]
                interval: 10s
                timeout: 3s
                retries: 20
              restart: unless-stopped
          
            iam-service:
              image: ECR/iam-service:latest
              container_name: iam-service
              depends_on:
                eureka-service:
                  condition: service_healthy
              # SIN .env: el runtime heredarÃ¡ variables ya exportadas por 'source /opt/cobox/cobox-env.sh'
              healthcheck:
                test: ["CMD","curl","-f","http://localhost:8081/actuator/health"]
                interval: 10s
                timeout: 3s
                retries: 20
              restart: unless-stopped
          
            fleet-service:
              image: ECR/fleet-service:latest
              container_name: fleet-service
              depends_on:
                iam-service:
                  condition: service_healthy
              healthcheck:
                test: ["CMD","curl","-f","http://localhost:8082/actuator/health"]
                interval: 10s
                timeout: 3s
                retries: 20
              restart: unless-stopped
          
            delivery-service:
              image: ECR/delivery-service:latest
              container_name: delivery-service
              depends_on:
                iam-service:
                  condition: service_healthy
              healthcheck:
                test: ["CMD","curl","-f","http://localhost:8083/actuator/health"]
                interval: 10s
                timeout: 3s
                retries: 20
              restart: unless-stopped
          
            gateway-service:
              image: ECR/gateway-service:latest
              container_name: gateway-service
              depends_on:
                eureka-service:
                  condition: service_healthy
                iam-service:
                  condition: service_healthy
                fleet-service:
                  condition: service_healthy
                delivery-service:
                  condition: service_healthy
              ports: ["80:8080"]
              healthcheck:
                test: ["CMD","curl","-f","http://localhost:8080/actuator/health"]
                interval: 10s
                timeout: 3s
                retries: 25
              restart: unless-stopped
          EOF
          
          sed -i "s|ECR|$ECR|g" docker-compose.aws.yml

      - name: Prep remote dir (/opt/cobox)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'set -e; sudo mkdir -p /opt/cobox && sudo chown $USER:$USER /opt/cobox'

      - name: Copy compose to EC2
        run: |
          scp -o StrictHostKeyChecking=no -i key.pem docker-compose.aws.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/cobox/

      - name: Deploy remotely (pull & up)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOSSH'
            set -e
            cd /opt/cobox
          
            # Verifica que el script de SSM exista
            if [ ! -x /opt/cobox/cobox-env.sh ]; then
              echo "Falta /opt/cobox/cobox-env.sh en la EC2 (crea con SSM como vimos)"; exit 1
            fi
          
            # Login a ECR (usando el rol de la EC2 no hace falta keys locales)
            aws ecr get-login-password --region us-east-2 \
              | docker login --username AWS --password-stdin 308740034831.dkr.ecr.us-east-2.amazonaws.com
          
            # Cargar variables desde SSM (rol EC2)
            source /opt/cobox/cobox-env.sh
          
            # Pull/Up con compose
            docker compose -f docker-compose.aws.yml pull
            docker compose -f docker-compose.aws.yml up -d
            docker compose -f docker-compose.aws.yml ps
          EOSSH
